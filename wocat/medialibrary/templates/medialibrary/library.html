{% extends 'base.html' %}
{% load compress i18n media_tags sekizai_tags %}

{% block content %}
  <form id="search-media-form">
    {% csrf_token %}
    <input type="hidden" name="page" id="media-search-pagination-input">
    <div class="row">
      <div class="col-sm-12">
        <div class="form-group">
          <input class="form-control" name="search"
                 placeholder="{% trans 'Search' %}" type="text"
                 value="{{ request.GET.search }}">
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-2">
        <div class="form-group">
          <select class="form-control" name="type">
            <option value="">{% trans 'All types' %}</option>
            {% with current=request.GET.type|add:"0" %}
              {% for type in types %}
                <option value="{{ type.id }}"
                        {% if type.id == current %}selected{% endif %}>{{ type }}</option>
              {% endfor %}
            {% endwith %}
          </select>
        </div>
      </div>
      <div class="col-sm-2">
        <div class="form-group">
          <select class="form-control" name="language">
            <option value="">{% trans 'All languages' %}</option>
            {% with current=request.GET.language %}
              {% for language in languages %}
                <option value="{{ language.code }}"
                        {% if language.code == current %}selected{% endif %}>{{ language }}</option>
              {% endfor %}
            {% endwith %}
          </select>
        </div>
      </div>
      <div class="col-sm-2">
        <div class="form-group">
          <select class="form-control" name="since">
            <option value="">{% trans 'Since (all years)' %}</option>
            {% with current=request.GET.since|add:"0" %}
              {% for year in years %}
                <option value="{{ year }}"
                        {% if year == current %}selected{% endif %}>{{ year }}</option>
              {% endfor %}
            {% endwith %}
          </select>
        </div>
      </div>
      <div class="col-sm-2">
        <div class="form-group">
          <select class="form-control" name="until">
            <option value="">{% trans 'Until (all years)' %}</option>
            {% with current=request.GET.until|add:"0" %}
              {% for year in years %}
                <option value="{{ year }}"
                        {% if year == current %}selected{% endif %}>{{ year }}</option>
              {% endfor %}
            {% endwith %}
          </select>
        </div>
      </div>
      <div class="col-sm-2">
        <div class="form-group">
          <select class="form-control" name="continent">
            <option value="">{% trans 'All continents' %}</option>
            {% with current=request.GET.continent|add:"0" %}
              {% for continent in continents %}
                <option value="{{ continent.id }}"
                        {% if continent.pk == current %}selected{% endif %}>{{ continent }}</option>
              {% endfor %}
            {% endwith %}
          </select>
        </div>
      </div>
      <div class="col-sm-2">
        <div class="form-group">
          <select class="form-control" name="country">
            <option value="">{% trans 'All countries' %}</option>
            {% with current=country %}
              {% for country in countries %}
                <option value="{{ country.code }}"
                        {% if country.code == current %}selected{% endif %}>{{ country }}</option>
              {% endfor %}
            {% endwith %}
          </select>
        </div>
      </div>
    </div>
  </form>
  <br>
  <div id="search-media-results">
    {% include 'medialibrary/library_items.html' %}
  </div>

  {% addtoblock "js" %}
    {% compress js %}
      <script>
          $(function () {
              var form = $('#search-media-form');
              form.find('select').change(submitForm);

              // Delay form submission when typing
              var timeoutId = 0;
              form.find('input[type=text]').keyup(function () {
                  clearTimeout(timeoutId);
                  timeoutId = setTimeout(submitForm, 500);
              });

              // Helper to actually submit the form
              function submitForm() {
                  form.submit();
              }

              // Submit form through AJAX
              form.submit(function (e) {
                  $.ajax({
                      type: "POST",
                      data: form.serialize(),
                      success: function (data) {
                          $('#search-media-results').html(data);
                          // Exclude csrftoken from form data
                          var formParams = form.find(':input[name!=csrfmiddlewaretoken]').serialize();
                          // Add params to URL
                          window.history.pushState('', '', '?' + formParams);
                      }
                  });
                  e.preventDefault();
              });

              // Intercept clicks on pagination links. Store selected page in
              // form and submit
              $('body').on('click', '.js-search-media-pagination', function(e) {
                  e.preventDefault();
                  $('#media-search-pagination-input').val($(this).data('page'));
                  submitForm();
              });
          });
      </script>
    {% endcompress %}
  {% endaddtoblock %}

{% endblock content %}
